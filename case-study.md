# Case-study оптимизации

## Актуальная проблема

Необходимо обработывать файлы с данными, чуть больше ста мегабайт за время не превышающее 30 секунд.

Имеется готовое решение успешно работающее на файлах размером в несколько мегабайт.
Но для большого файла программа работала слишком долго, без прогноза необходимого времени.

## Формирование метрики

Для анализа влияния изменений кода на быстродействие программы выбрана метрика: 
время работы программы на различных объемах данных.

## Гарантия корректности работы оптимизированной программы

Программа поставлялась с тестом. Выполнение этого теста в фидбек-лупе позволяет не допустить изменения логики программы при оптимизации.

## Подготовительный этап

- Подготовлены наборы данных различной длины (с двухкратным увеличением количества строк)
- Добавлен скрипт запускающий benchmark для замера времени работы алгоритма на различном размере данных

## Feedback-Loop

- Настраиваем и запускаем выбранный инструмент профилирования, анализируем его работу для нахождения главной точки роста.
  - При недостатке данных выбираем другой инструмент профилирования и повторяем замеры и анализ.
- Вносим небольшие изменения в проблемный участок кода для оптимизации.
- Проверяем стабильность программы запуском теста.
  - При проваленном тесте возвращаемся к исправлению кода.
- Проверяем результат оптимизиции на основе изменений выбранной метрики.
  - При отсутствии положительных изменений возвращаемся к исправлению кода.
- Фиксируем результат в системе контроля версий.
- Фиксируем время прохождения цикла Feedback-Loop для посдующей фиксации в текущем документе

Итог: один проход по Feedback-Loop занимал в среднем TODO минут.

## Главные точки роста

Для того, чтобы найти "точки роста" были использованы:

- ruby-prof
  - wall time report
    - graph_html

Вот какие проблемы удалось найти и решить

### Вызов select внутри цикла

Метод select вызывался на одном и том же массиве на каждую итерацию основного цикла

- какой отчёт показал главную точку роста
  - wall time
- как вы решили её оптимизировать
  - предварительная группировка данных массива
- как изменилась метрика
  | количество строк | было    | стало |
  | ---------------  | ------- | ----- |
  | 1k               | 14ms    |       |
  | 2k               | 45ms    |       |
  | 4k               | 166ms   |       |
  | 8k               | 606ms   |       |
  | 16k              | 2431ms  |       |
  | 3250940          | 27h[^1] |       |
  [^1]: предположительное значение

- как изменился отчёт профилировщика - исправленная проблема перестала быть главной точкой роста?
  - да


## Результаты

Удалось обработать файл с данными.
Удалось улучшить целевую метрику системы и уложиться в заданный бюджет.
было:  *27 часов*
стало: *TODO сек*

TODO: дополнительные достижения

## Защита от регрессии производительности

Для защиты от потери достигнутого прогресса при дальнейших изменениях программы были добавлены 2 теста:

- TODO: На линейное время выполнение алгоритма
- TODO: На выполнение работы программы в пределах заданных требований по времени работы

